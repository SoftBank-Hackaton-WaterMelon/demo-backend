name: AWS CodeDeploy 

on:
  repository_dispatch:
    types: [dev_deploy]
  workflow_dispatch:
    inputs:
      action:
        description: "deploy"
        required: false
        default: "deploy"
      version:
        description: "Version (e.g., v1.2.3)"
        required: false

env:
  GHCR_IMAGE_URI_BASE: ${{ secrets.GHCR_IMAGE_URI_BASE }}
  AWS_REGION: ${{ secrets.AWS_REGION }}
  ECS_CLUSTER: ${{ secrets.ECS_CLUSTER }}
  ECS_SERVICE: ${{ secrets.ECS_SERVICE }}
  CONTAINER_NAME: ${{ secrets.TASK_CONTAINER_NAME }}
  CODEDEPLOY_APP_NAME: ${{ secrets.CODEDEPLOY_APP_NAME }}
  CODEDEPLOY_DEPLOYMENT_GROUP: ${{ secrets.CODEDEPLOY_DEPLOYMENT_GROUP }}
  tag: ${{ github.event.client_payload.message || 'latest' }}
  APPSPEC_FILE_PATH: appspec.yaml

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Checkout Repository
        uses: actions/checkout@v4

      - name: 2. Configure AWS Credentials (Access Key)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: 3. Get Current Task Definition
        id: get-task-def
        run: |
          echo "ğŸ”¹ Fetching active task definition ARN from service: ${{ env.ECS_SERVICE }}"
          TASK_DEF_ARN=$(aws ecs describe-services --cluster ${{ env.ECS_CLUSTER }} --services ${{ env.ECS_SERVICE }} --query 'services[0].taskDefinition' --output text)
          
          if [ -z "$TASK_DEF_ARN" ]; then
            echo "âŒ Error: Could not find task definition for service: ${{ env.ECS_SERVICE }}"
            exit 1
          fi

          echo "Found ARN: $TASK_DEF_ARN"
          
          echo "ğŸ”¹ Fetching full task definition JSON..."
          aws ecs describe-task-definition --task-definition $TASK_DEF_ARN --query 'taskDefinition' > task-def-base.json
          
          echo "task-def-base.json created."

      - name: 4. Create New Task Definition JSON
        id: create-task-def
        run: |
          IMAGE_TAG="${{ env.tag }}"
          if [ -z "$IMAGE_TAG" ]; then
            IMAGE_TAG="${GITHUB_SHA::7}"
          fi
          NEW_IMAGE_URI="${{ env.GHCR_IMAGE_URI_BASE }}:$IMAGE_TAG"
          
          echo "ğŸ”¹ Creating new task definition with image: $NEW_IMAGE_URI"
          
          # jqë¥¼ ì‚¬ìš©í•˜ì—¬ ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ì£¼ì†Œë¥¼ ì—…ë°ì´íŠ¸í•˜ê³ , register-task-definitionì— ë¶ˆí•„ìš”í•œ í‚¤ë“¤(ARN, revision ë“±)ì„ ì œê±°í•©ë‹ˆë‹¤.
          jq --arg CONTAINER_NAME "${{ env.CONTAINER_NAME }}" \
             --arg IMAGE_URI "$NEW_IMAGE_URI" \
             '(.containerDefinitions[] | select(.name == $CONTAINER_NAME) | .image) = $IMAGE_URI | 
              del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy)' \
             task-def-base.json > task-def-new.json

          echo "task-def-new.json created."

      - name: 5. Register New Task Definition
        id: register-task-def
        run: |
          echo "ğŸ”¹ Registering new task definition..."
          NEW_TASK_DEF_JSON=$(aws ecs register-task-definition --cli-input-json file://task-def-new.json)
          
          NEW_TASK_DEF_ARN=$(echo $NEW_TASK_DEF_JSON | jq -r '.taskDefinition.taskDefinitionArn')
          
          if [ -z "$NEW_TASK_DEF_ARN" ]; then
            echo "âŒ Error: Failed to register new task definition."
            exit 1
          fi
          
          echo "âœ… Successfully registered new task definition: $NEW_TASK_DEF_ARN"
          echo "NEW_TASK_DEF_ARN=$NEW_TASK_DEF_ARN" >> $GITHUB_OUTPUT

      - name: 6. Create CodeDeploy Revision JSON
        id: create-revision
        run: |
          NEW_TASK_DEF_ARN=${{ steps.register-task-def.outputs.NEW_TASK_DEF_ARN }}
          
          echo "ğŸ”¹ Rendering AppSpec file with new ARN: $NEW_TASK_DEF_ARN"
          
          # appspec.yaml í…œí”Œë¦¿ì˜ <TASK_DEFINITION_ARN> í”Œë ˆì´ìŠ¤í™€ë”ë¥¼ ì‹¤ì œ ARNìœ¼ë¡œ êµì²´
          sed "s|<TASK_DEFINITION_ARN>|$NEW_TASK_DEF_ARN|" ${{ env.APPSPEC_FILE_PATH }} > appspec-rendered.yaml
          
          echo "ğŸ”¹ Creating revision.json for CodeDeploy..."
          
          # CodeDeploy create-deploymentê°€ ìš”êµ¬í•˜ëŠ” revision JSON í¬ë§· ìƒì„±
          # appspec-rendered.yaml íŒŒì¼ì˜ ì „ì²´ ë‚´ìš©ì„ ë¬¸ìì—´ë¡œ ì½ì–´ JSON ë‚´ë¶€ì— ì‚½ì…
          cat appspec-rendered.yaml | jq -R -s '{revisionType: "AppSpecContent", appSpecContent: {content: .}}' > revision.json
          
          echo "revision.json created."

      - name: 7. Start CodeDeploy Deployment
        run: |
          echo "ğŸš€ Starting CodeDeploy deployment..."
          
          aws deploy create-deployment \
            --application-name ${{ env.CODEDEPLOY_APP_NAME }} \
            --deployment-group-name ${{ env.CODEDEPLOY_DEPLOYMENT_GROUP }} \
            --revision file://revision.json \
            --deployment-config-name CodeDeployDefault.ECSAllAtOnce # ë˜ëŠ” ì›í•˜ëŠ” ë°°í¬ ì „ëµ (ì˜ˆ: CodeDeployDefault.ECSCanary10Percent5Minutes)
            
          echo "âœ… Deployment initiated successfully!"
      - name: Notify Slack (AWS deployment created)
        if: success()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          payload='{
            "text": ":white_check_mark: *AWS deployment created* - Succeeded",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": ":white_check_mark: ë°°í¬ ì‘ì—…ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤. ë°°í¬ ìƒíƒœëŠ” AWS CodeDeploy ì½˜ì†”ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
                  }
                },
                {
                  "type": "image",
                  "image_url": "https://github.com/SoftBank-Hackaton-WaterMelon/Chiikawa/blob/main/chiikawa-marshmallow.gif?raw=true",
                  "alt_text": "Success - Thumbs up dog"
                }
              ]
            }'
            curl -X POST -H 'Content-type: application/json' --data "$payload" $SLACK_WEBHOOK_URL

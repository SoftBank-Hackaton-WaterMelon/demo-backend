name: docker image build and push

on:
  push:
    branches:
      - main
    tags:
      - 'v*.*.*'
    paths-ignore:
      - '.github/**'
  workflow_dispatch:

env:
  IMAGE_NAME: ghcr.io/${{ github.repository }}
  DOCKERFILE_PATH: ./Dockerfile

jobs:
  build:
    name: Pre-Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Lint (optional)
        run: npm run lint --if-present

      - name: Syntax check
        run: node --check src/server.cjs

      - name: Notify Slack (Pre-Check success)
        if: success()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          payload='{
            "text": ":white_check_mark: *Pre-Check job* - Succeeded",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": ":white_check_mark: *Pre-Check job* - `Succeeded`\n*ë¸Œëœì¹˜/íƒœê·¸*: `${{ github.ref_name }}`\n*ì»¤ë°‹*: `${{ github.sha }}`\n\ní›„í›„, ì¤€ë¹„ëŠ” ì™„ë²½í•´ìš”! ğŸŒŸ ì½”ë“œì— ì´ìƒ ì—†ëŠ”ì§€ ë¨¼ì € ì‚´í´ë³¼ê²Œìš”.\nã€Œãµãµã£ã€æº–å‚™ã¯ã°ã£ã¡ã‚Šã§ã™!ğŸŒŸ ã‚³ãƒ¼ãƒ‰ã«å•é¡ŒãŒãªã„ã‹ã€ã¾ãšãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã­ã€‚ã€"
                }
              },
              {
                "type": "image",
                "image_url": "https://github.com/SoftBank-Hackaton-WaterMelon/Chiikawa/blob/main/task_start.gif?raw=true",
                "alt_text": "Success - Thumbs up dog"
              }
            ]
          }'
          curl -X POST -H 'Content-type: application/json' --data "$payload" $SLACK_WEBHOOK_URL

      - name: Notify Slack (Pre-Check failure)
        if: failure()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          payload='{
            "text": ":x: *Pre-Check job* - Failed",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": ":x: *Pre-Check job* - `Failed`\n*ë¸Œëœì¹˜/íƒœê·¸*: `${{ github.ref_name }}`\n*ì»¤ë°‹*: `${{ github.sha }}`\n\nì•„ì´ê³ , ì½”ë“œì— ì´ìƒì´ ìˆëŠ” ê²ƒ ê°™ì•„ìš”. ë¨¼ì € ìˆ˜ì •í•´ì£¼ì„¸ìš”.\nã€Œã‚ã‚Œã‚Œã€ã‚³ãƒ¼ãƒ‰ã«å•é¡ŒãŒã‚ã‚‹ã‚ˆã†ã§ã™ã­ã€‚ã¾ãšä¿®æ­£ã—ã¦ãã ã•ã„ã€‚ã€"
                }
              },
              {
                "type": "image",
                "image_url": "https://github.com/SoftBank-Hackaton-WaterMelon/Chiikawa/blob/main/failed.gif?raw=true",
                "alt_text": "Failure - Sad cat"
              }
            ]
          }'
          curl -X POST -H 'Content-type: application/json' --data "$payload" $SLACK_WEBHOOK_URL

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: node --test

      - name: Notify Slack (Test success)
        if: success()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          payload='{
            "text": ":white_check_mark: *Test job* - Succeeded",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": ":white_check_mark: *Test job* - `Succeeded`\n*ë¸Œëœì¹˜/íƒœê·¸*: `${{ github.ref_name }}`\n*ì»¤ë°‹*: `${{ github.sha }}`\n\ní…ŒìŠ¤íŠ¸ í†µê³¼~! ğŸ¶ ì´ì œ ìì‹  ìˆê²Œ ë¹Œë“œí•  ìˆ˜ ìˆê² ì–´ìš”.\nã€Œãƒ†ã‚¹ãƒˆåˆæ ¼ã€œ!ğŸ¶ ã“ã‚Œã§è‡ªä¿¡ã‚’ã‚‚ã£ã¦ãƒ“ãƒ«ãƒ‰ã§ãã¾ã™ï¼ã€"
                }
              },
              {
                "type": "image",
                "image_url": "https://github.com/SoftBank-Hackaton-WaterMelon/Chiikawa/blob/main/building.gif?raw=true",
                "alt_text": "Success - Thumbs up dog"
              }
            ]
          }'
          curl -X POST -H 'Content-type: application/json' --data "$payload" $SLACK_WEBHOOK_URL

      - name: Notify Slack (Test failure)
        if: failure()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          payload='{
            "text": ":x: *Test job* - Failed",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": ":x: *Test job* - `Failed`\n*ë¸Œëœì¹˜/íƒœê·¸*: `${{ github.ref_name }}`\n*ì»¤ë°‹*: `${{ github.sha }}`\n\nì•„ì´ê³ , í…ŒìŠ¤íŠ¸ì—ì„œ ì´ìƒì´ ìˆëŠ” ê²ƒ ê°™ì•„ìš”. ë¨¼ì € ìˆ˜ì •í•´ì£¼ì„¸ìš”.\nã€Œã‚ã‚Œã‚Œã€ãƒ†ã‚¹ãƒˆã§å•é¡ŒãŒã‚ã‚‹ã‚ˆã†ã§ã™ã­ã€‚ã¾ãšä¿®æ­£ã—ã¦ãã ã•ã„ã€‚ã€"
                }
              },
              {
                "type": "image",
                "image_url": "https://github.com/SoftBank-Hackaton-WaterMelon/Chiikawa/blob/main/failed.gif?raw=true",
                "alt_text": "Failure - Sad cat"
              }
            ]
          }'
          curl -X POST -H 'Content-type: application/json' --data "$payload" $SLACK_WEBHOOK_URL

  build_and_push_docker:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: test
    permissions:
      contents: read
      packages: write
    outputs:
      image-name: ${{ steps.export.outputs.image-name }}
      image-tag: ${{ steps.export.outputs.image-tag }}

    steps:
      - name: Notify Slack (Build Start)
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          payload='{
            "text": ":hammer_and_wrench: *Build Start*",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": ":hammer_and_wrench: *Build Start*\n*ë¸Œëœì¹˜/íƒœê·¸*: `${{ github.ref_name }}`\n*ì»¤ë°‹*: `${{ github.sha }}`\n\nì´ì œ ì§„ì§œ ë¹Œë“œ ì‹œì‘ì´ì—ìš”! ğŸ’ª ì´ë¯¸ì§€ í•˜ë‚˜í•˜ë‚˜ ì •ì„±ê» ë§Œë“œëŠ” ì¤‘...\nã€Œã„ã‚ˆã„ã‚ˆãƒ“ãƒ«ãƒ‰é–‹å§‹ã§ã™ï¼ğŸ’ª ä¸€ã¤ã²ã¨ã¤ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å¿ƒã‚’ã“ã‚ã¦ä½œã£ã¦ã„ã¾ã™â€¦ã€"
                }
              },
              {
                "type": "image",
                "image_url": "https://github.com/SoftBank-Hackaton-WaterMelon/Chiikawa/blob/main/deploying.gif?raw=true",
                "alt_text": "Build Start - Deploying"
              }
            ]
          }'
          curl -X POST -H 'Content-type: application/json' --data "$payload" $SLACK_WEBHOOK_URL
          
      - name: Checkout
        uses: actions/checkout@v4

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=edge
            type=ref,event=tag
            type=raw,value=build-${{ github.run_number }}
            type=sha,format=short,event=branch

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ${{ env.DOCKERFILE_PATH }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

      - name: Export image metadata
        id: export
        run: |
          echo "image-name=${{ env.IMAGE_NAME }}" >> "$GITHUB_OUTPUT"
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            echo "image-tag=${{ github.ref_name }}" >> "$GITHUB_OUTPUT"
          else
            echo "image-tag=build-${{ github.run_number }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Format Docker Tags for Slack
        if: success()
        id: format_tags
        run: |
          tags="${{ steps.meta.outputs.tags }}"
          tags="${tags//$'\n'/\\n}"
          echo "slack-tags=$tags" >> "$GITHUB_OUTPUT"

      - name: Notify Slack (Build and Push Docker Image success)
        if: success()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          payload='{
            "text": ":white_check_mark: *Build and Push Docker Image job* - Succeeded",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": ":white_check_mark: *Build and Push Docker Image job* - `Succeeded`\n*ë¸Œëœì¹˜/íƒœê·¸*: `${{ github.ref_name }}`\n*ì»¤ë°‹*: `${{ github.sha }}`\n*ìƒì„±ëœ íƒœê·¸*:\n${{ steps.format_tags.outputs.slack-tags }}\n\nì™„ì„±ëœ ì´ë¯¸ì§€ë¥¼ ë¦¬í¬ì§€í† ë¦¬ì— í‘¸ì‰¬ ì¤‘ì´ì—ìš”! ğŸš€ ì ê¹ë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”~\nã€Œå®Œæˆã—ãŸã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒªãƒã‚¸ãƒˆãƒªã«ãƒ—ãƒƒã‚·ãƒ¥ä¸­ã§ã™ï¼ğŸš€ ã‚‚ã†å°‘ã—ã ã‘å¾…ã£ã¦ã¦ãã ã•ã„ã­ã€œã€"
                }
              },
              {
                "type": "image",
                "image_url": "https://github.com/SoftBank-Hackaton-WaterMelon/Chiikawa/blob/main/build_complete.gif?raw=true",
                "alt_text": "Success - Thumbs up dog"
              }
            ]
          }'
          curl -X POST -H 'Content-type: application/json' --data "$payload" $SLACK_WEBHOOK_URL

      - name: Notify Slack (Build and Push Docker Image failure)
        if: failure()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          payload='{
            "text": ":x: *Build and Push Docker Image job* - Failed",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": ":x: *Build and Push Docker Image job* - `Failed`\n*ë¸Œëœì¹˜/íƒœê·¸*: `${{ github.ref_name }}`\n*ì»¤ë°‹*: `${{ github.sha }}`\n\nì•„ì´ê³ , ì´ë¯¸ì§€ ë¹Œë“œì—ì„œ ì´ìƒì´ ìˆëŠ” ê²ƒ ê°™ì•„ìš”. ë¨¼ì € ìˆ˜ì •í•´ì£¼ì„¸ìš”.\nã€Œã‚ã‚Œã‚Œã€ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ã§å•é¡ŒãŒã‚ã‚‹ã‚ˆã†ã§ã™ã­ã€‚ã¾ãšä¿®æ­£ã—ã¦ãã ã•ã„ã€‚ã€"
                }
              },
              {
                "type": "image",
                "image_url": "https://github.com/SoftBank-Hackaton-WaterMelon/Chiikawa/blob/main/failed.gif?raw=true",
                "alt_text": "Failure - Sad cat"
              }
            ]
          }'
          curl -X POST -H 'Content-type: application/json' --data "$payload" $SLACK_WEBHOOK_URL

  notify_slack:
    name: Notify Slack of Workflow Status
    runs-on: ubuntu-latest
    needs:
      - build
      - test
      - build_and_push_docker
    if: always() # í•­ìƒ ì‹¤í–‰ë˜ë„ë¡ ë³´ì¥

    steps:
      - name: Send final status
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          payload='{
            "text": ":checkered_flag: *CI/CD ì‹¤í–‰ ê²°ê³¼*\nBuild: `${{ needs.build.result }}`\nTest: `${{ needs.test.result }}`\nDocker: `${{ needs.build_and_push_docker.result }}`\n",
              "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "ëª¨ë“  ë‹¨ê³„ê°€ ì„±ê³µì´ì—ìš”! ì½”ë“œë„, ë¹Œë“œë„, ë„ì»¤ë„ ì™„ë²½âœ¨\nã€Œã™ã¹ã¦ã®ã‚¹ãƒ†ãƒƒãƒ—ãŒæˆåŠŸã§ã™ï¼âœ¨ ã‚³ãƒ¼ãƒ‰ã‚‚ã€ãƒ“ãƒ«ãƒ‰ã‚‚ã€ãƒ‰ãƒƒã‚«ãƒ¼ã‚‚å®Œç’§ï¼ã€"
                }
              },
              {
                "type": "image",
                "image_url": "https://github.com/SoftBank-Hackaton-WaterMelon/Chiikawa/blob/main/ci_done.gif?raw=true",
                "alt_text": "Failure - Sad cat"
              }
            ]
          }'
          curl -X POST -H 'Content-type: application/json' --data "$payload" $SLACK_WEBHOOK_URL
